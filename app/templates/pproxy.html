{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                <div>
                    <strong>üîß PProxy</strong>
                    <span id="pproxy-status" class="badge bg-secondary ms-2">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                </div>
                <div class="d-flex gap-2">
                    <button id="install-btn" class="btn btn-sm btn-outline-primary d-none">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å pproxy</button>
                    <small class="text-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ pproxy –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</small>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label">–ö–æ–º–∞–Ω–¥–∞ pproxy</label>
                        <div class="input-group">
                            <span class="input-group-text">pproxy</span>
                            <input type="text" id="command-input" class="form-control" placeholder="-l http://:8080 -r http://example.com:80" autofocus>
                        </div>
                        <div class="form-text">–ú–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –ø–æ–ª–Ω—É—é –∫–æ–º–∞–Ω–¥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, <code>pproxy --help</code>).</div>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button id="run-btn" class="btn btn-primary w-100">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                    </div>
                </div>

                <div class="mt-3 d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-secondary btn-sm preset" data-cmd="pproxy --help">--help</button>
                    <button class="btn btn-outline-secondary btn-sm preset" data-cmd="pproxy -r http://10.0.0.1:3128 -vv">–ü—Ä–æ–∫—Å–∏ ‚Üí –ø—Ä–∏–º–µ—Ä</button>
                </div>

                <div class="mt-4">
                    <label class="form-label">–í—ã–≤–æ–¥</label>
                    <div class="terminal" id="terminal" style="height: 320px;">
                        <pre id="output" class="mb-0" style="white-space: pre-wrap; color: #00ff00;">> –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã...</pre>
                    </div>
                </div>

                <div class="mt-4">
                    <label class="form-label">–õ–æ–≥–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ pproxy</label>
                    <div class="terminal" id="install-terminal" style="height: 200px;">
                        <pre id="install-output" class="mb-0" style="white-space: pre-wrap; color: #00ff00;">> –û–∂–∏–¥–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏...</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const statusBadge = document.getElementById('pproxy-status');
    const commandInput = document.getElementById('command-input');
    const output = document.getElementById('output');
    const runBtn = document.getElementById('run-btn');
    const terminal = document.getElementById('terminal');
    const installTerminal = document.getElementById('install-terminal');
    const installOutput = document.getElementById('install-output');
    const installBtn = document.getElementById('install-btn');

    async function fetchStatus() {
        try {
            const res = await fetch('/pproxy/status');
            const data = await res.json();
            if (data.installed) {
                statusBadge.textContent = data.version ? `–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (${data.version})` : '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                statusBadge.className = 'badge bg-success ms-2';
                installBtn.classList.add('d-none');
            } else {
                statusBadge.textContent = '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                statusBadge.className = 'badge bg-danger ms-2';
                installBtn.classList.remove('d-none');
                appendOutput('pproxy –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞–∫–µ—Ç –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º.', true);
            }
        } catch (e) {
            statusBadge.textContent = '–û—à–∏–±–∫–∞';
            statusBadge.className = 'badge bg-warning text-dark ms-2';
            appendOutput('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å pproxy: ' + e.message, true);
        }
    }

    function appendOutput(text, isError = false) {
        const prefix = isError ? '‚ùó ' : '';
        const current = output.textContent === '> –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã...' ? '' : output.textContent + '\n';
        output.textContent = current + prefix + text;
        terminal.scrollTop = terminal.scrollHeight;
    }

    function appendInstallOutput(text, isError = false) {
        const prefix = isError ? '‚ùó ' : '';
        const current = installOutput.textContent === '> –û–∂–∏–¥–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏...' ? '' : installOutput.textContent + '\n';
        installOutput.textContent = current + prefix + text;
        installTerminal.scrollTop = installTerminal.scrollHeight;
    }

    async function installPproxy() {
        installBtn.disabled = true;
        appendInstallOutput('> –£—Å—Ç–∞–Ω–æ–≤–∫–∞ pproxy...');
        try {
            const res = await fetch('/pproxy/install', { method: 'POST' });
            const data = await res.json();
            if (data.stdout) appendInstallOutput(data.stdout.trim());
            if (data.stderr) appendInstallOutput(data.stderr.trim(), true);
            if (res.ok && data.success) {
                appendInstallOutput('–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', false);
                await fetchStatus();
            } else {
                appendInstallOutput('–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π. –ö–æ–¥: ' + (data.returncode ?? 'unknown'), true);
            }
        } catch (e) {
            appendInstallOutput('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏: ' + e.message, true);
        } finally {
            installBtn.disabled = false;
        }
    }

    async function runCommand() {
        const cmd = commandInput.value.trim();
        if (!cmd) {
            appendOutput('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É pproxy', true);
            return;
        }

        runBtn.disabled = true;
        runBtn.textContent = '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
        appendOutput('> ' + cmd);

        try {
            const res = await fetch('/pproxy/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: cmd })
            });

            const data = await res.json();
            if (!res.ok) {
                appendOutput(data.detail || '–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è', true);
            } else {
                if (data.stdout) appendOutput(data.stdout.trim());
                if (data.stderr) appendOutput(data.stderr.trim(), true);
                if (data.returncode !== 0) appendOutput(`–ö–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞: ${data.returncode}`, true);
            }
        } catch (e) {
            appendOutput('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + e.message, true);
        } finally {
            runBtn.disabled = false;
            runBtn.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å';
        }
    }

    document.querySelectorAll('.preset').forEach(btn => {
        btn.addEventListener('click', () => {
            commandInput.value = btn.dataset.cmd;
            commandInput.focus();
        });
    });

    commandInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            runCommand();
        }
    });

    runBtn.addEventListener('click', runCommand);
    installBtn.addEventListener('click', installPproxy);

    fetchStatus();
</script>
{% endblock %}